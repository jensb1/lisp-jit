#!/usr/bin/env node
// Test: Execute machine code generated by the Lisp code generator

const { JitExecutor } = require('./dist/jit');

// These bytes were generated by lisp/test-codegen.lisp
// Program: return (+ 10 32) = 42
const codeBytes = new Uint8Array([
  1, 0, 0, 20,           // B _main (skip to offset 4)
  253, 123, 191, 169,    // STP X29, X30, [SP, #-16]!
  253, 3, 31, 170,       // MOV X29, SP
  64, 1, 128, 210,       // MOVZ X0, #10
  1, 4, 128, 210,        // MOVZ X1, #32
  0, 0, 1, 139,          // ADD X0, X0, X1
  253, 123, 193, 168,    // LDP X29, X30, [SP], #16
  192, 3, 95, 214        // RET
]);

console.log('Testing Lisp-generated machine code...');
console.log('Code bytes:', codeBytes.length);

const executor = new JitExecutor();
executor.allocate(1024 * 1024, 64 * 1024 * 1024);
executor.write(codeBytes);
const result = executor.execute();
executor.free();

console.log('Result:', result);
console.log('Expected: 42');
console.log(result === 42 ? 'SUCCESS!' : 'FAILED!');
